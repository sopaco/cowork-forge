# Cowork Forge 工具执行域技术文档

## 1. 概述

### 1.1 模块定位
工具执行域是 Cowork Forge 系统的核心业务支持模块，负责为智能体提供原子化的操作能力。该模块通过统一的 Tool trait 接口，将复杂的文件操作、数据管理、验证检查、人机交互等操作封装为标准化的工具，使智能体能够专注于业务逻辑而无需关心底层实现细节。

### 1.2 核心价值
- **标准化操作**：将复杂操作封装为统一接口的原子工具
- **安全性保障**：内置路径验证、命令执行限制等安全机制
- **可扩展性**：模块化设计支持新工具的快速集成
- **会话隔离**：支持会话作用域的工具实例，确保数据隔离

## 2. 架构设计

### 2.1 模块组织结构
```
crates/cowork-core/src/tools/
├── mod.rs                    # 工具模块聚合器
├── file_tools.rs             # 文件操作工具 (16.2KB)
├── data_tools.rs             # 数据操作工具 (33.3KB)
├── validation_tools.rs       # 验证工具 (9.0KB)
├── hitl_tools.rs             # 基础HITL工具 (9.1KB)
├── hitl_content_tools.rs     # 内容HITL工具 (5.9KB)
├── control_tools.rs          # 控制工具 (10.4KB)
├── artifact_tools.rs         # 产物工具 (5.8KB)
├── modify_tools.rs           # 修改工具 (7.1KB)
├── idea_tools.rs             # 想法工具 (2.1KB)
└── goto_stage_tool.rs        # 阶段导航工具 (2.9KB)
```

### 2.2 核心接口设计
所有工具均实现 `Tool` trait，提供标准化的接口：
```rust[async_trait]
pub trait Tool: Send + Sync {
    fn name(&self) -> &str;                    // 工具唯一标识
    fn description(&self) -> &str;             // 工具功能描述
    fn parameters_schema(&self) -> Option<Value>; // 参数模式定义
    async fn execute(&self, ctx: Arc<dyn ToolContext>, args: Value) -> Result<Value>;
}
```

## 3. 核心工具类别

### 3.1 文件操作工具 (File Tools)
**文件位置**: `crates/cowork-core/src/tools/file_tools.rs`

#### 3.1.1 安全路径验证机制
```rust
fn validate_path_security(path: &str) -> Result<PathBuf, String> {
    // 规则1: 拒绝绝对路径
    // 规则2: 拒绝父目录访问 (..)
    // 规则3: 验证路径在当前目录内
}
```

#### 3.1.2 核心工具列表
- **ListFilesTool**: 目录文件列表（支持递归）
- **ReadFileTool**: 文件内容读取
- **WriteFileTool**: 文件写入操作
- **RunCommandTool**: 命令执行（带安全限制）

### 3.2 数据操作工具 (Data Tools)
**文件位置**: `crates/cowork-core/src/tools/data_tools.rs`

#### 3.2.1 会话作用域设计
```rust
pub struct CreateRequirementTool {
    session_id: String,  // 会话ID绑定
}
```

#### 3.2.2 结构化数据管理
- **CreateRequirementTool**: 创建需求（支持SMART原则）
- **AddFeatureTool**: 添加功能特性
- **CreateDesignComponentTool**: 设计组件创建
- **CreateTaskTool**: 任务创建与管理
- **UpdateStatusTools**: 状态更新工具组
- **GetTools**: 数据查询工具组

### 3.3 验证工具 (Validation Tools)
**文件位置**: `crates/cowork-core/src/tools/validation_tools.rs`

#### 3.3.1 数据格式验证
```rust
match data_type {
    "requirements" => self.validate_requirements_schema(),
    "features" => self.validate_features_schema(),
    "design" => self.validate_design_schema(),
    "plan" => self.validate_plan_schema(),
}
```

#### 3.3.2 验证规则
- **CheckDataFormatTool**: 数据模式验证
- **CheckFeatureCoverageTool**: 功能覆盖检查
- **CheckTaskDependenciesTool**: 任务依赖验证

### 3.4 HITL交互工具 (Human-in-the-Loop Tools)

#### 3.4.1 基础交互工具 (`hitl_tools.rs`)
- **ReviewAndEditFileTool**: 文件审阅与编辑
- **ReviewWithFeedbackTool**: 带反馈的审阅（三种模式）
- **ReviewAndEditContentTool**: 内容审阅编辑

#### 3.4.2 高级交互工具 (`hitl_content_tools.rs`)
- 支持复杂内容预览和用户反馈收集

### 3.5 控制工具 (Control Tools)
**文件位置**: `crates/cowork-core/src/tools/control_tools.rs`

#### 3.5.1 流程控制
- **ProvideFeedbackTool**: 用户反馈收集
- **RequestReplanningTool**: 重新规划请求
- **AskUserTool**: 用户询问工具

### 3.6 产物工具 (Artifact Tools)
**文件位置**: `crates/cowork-core/src/tools/artifact_tools.rs`

#### 3.6.1 交付产物管理
- **SaveDeliveryReportTool**: 交付报告保存
- **SavePrdDocTool**: PRD文档保存
- **SaveDesignDocTool**: 设计文档保存

### 3.7 修改工具 (Modify Tools)
**文件位置**: `crates/cowork-core/src/tools/modify_tools.rs`

#### 3.7.1 变更管理
- **SaveChangeRequestTool**: 变更请求保存
- **LoadChangeRequestTool**: 变更请求加载

### 3.8 想法工具 (Idea Tools)
**文件位置**: `crates/cowork-core/src/tools/idea_tools.rs`

#### 3.8.1 想法阶段支持
- **SaveIdeaTool**: 想法保存
- **LoadIdeaTool**: 想法加载

### 3.9 阶段导航工具 (Goto Stage Tool)
**文件位置**: `crates/cowork-core/src/tools/goto_stage_tool.rs`

#### 3.9.1 流程跳转
- **GotoStageTool**: 阶段跳转控制

## 4. 技术实现细节

### 4.1 异步执行模型
所有工具均使用 `async_trait` 宏实现异步执行：
```rust
#[async_trait]
impl Tool for ListFilesTool {
    async fn execute(&self, _ctx: Arc<dyn ToolContext>, args: Value) -> adk_core::Result<Value> {
        // 异步实现
    }
}
```

### 4.2 参数验证机制
通过 JSON Schema 定义工具参数约束：
```rust
fn parameters_schema(&self) -> Option<Value> {
    Some(json!({
        "type": "object",
        "properties": {
            "path": {"type": "string", "description": "目录路径"},
            "recursive": {"type": "boolean", "description": "是否递归"}
        }
    }))
}
```

### 4.3 错误处理策略
- 使用 `adk_core::AdkError` 统一错误类型
- 提供详细的错误信息和状态码
- 支持工具级别的错误恢复

### 4.4 会话管理
- 会话作用域工具绑定特定会话ID
- 支持会话数据的隔离和持久化
- 提供会话级别的工具实例管理

## 5. 安全机制

### 5.1 路径安全
- 强制相对路径，拒绝绝对路径访问
- 禁止父目录遍历 (`..`)
- 路径规范化验证

### 5.2 命令执行限制
- 白名单机制限制可执行命令
- 超时控制和资源限制
- 输出大小限制

### 5.3 数据验证
- 输入参数格式验证
- 数据完整性检查
- 边界条件处理

## 6. 集成与调用

### 6.1 智能体集成模式
```rust
// 智能体通过工具名称调用
let result = agent.call_tool("list_files", json!({
    "path": "src",
    "recursive": true
})).await;
```

### 6.2 工具发现机制
通过 `mod.rs` 统一暴露所有工具接口：
```rust
pub use data_tools::*;
pub use validation_tools::*;
pub use control_tools::*;
// ... 其他工具
```

### 6.3 上下文传递
支持 `ToolContext` 上下文传递，提供：
- 会话状态信息
- 配置参数
- 运行时环境

## 7. 性能优化

### 7.1 内存管理
- 使用 `Arc` 共享不可变数据
- 避免不必要的克隆操作
- 大文件流式处理

### 7.2 异步优化
- 非阻塞I/O操作
- 并发工具执行支持
- 资源池管理

## 8. 扩展性设计

### 8.1 新工具集成
1. 实现 `Tool` trait
2. 在对应工具模块中定义
3. 在 `mod.rs` 中暴露接口

### 8.2 自定义工具开发
支持第三方工具集成，只需符合 `Tool` trait 接口规范。

## 9. 总结

工具执行域作为 Cowork Forge 系统的操作执行层，提供了标准化、安全、可扩展的工具接口。通过模块化设计和统一接口规范，该域有效降低了智能体的开发复杂度，同时确保了系统的安全性和稳定性。其设计充分体现了"最小可行架构"原则，在提供丰富功能的同时保持了代码的简洁性和可维护性。

该模块的成功实施为整个系统的自动化开发流程提供了坚实的技术基础，是 Cowork Forge 实现从想法到代码全流程自动化的关键支撑组件。