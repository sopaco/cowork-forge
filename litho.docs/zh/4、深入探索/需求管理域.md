# 需求管理域技术文档

## 1. 模块概述

需求管理域是Cowork Forge系统的核心业务域，负责项目需求的采集、分析、结构化和管理。该域采用模块化架构，包含创意代理、PRD代理和变更分析三个核心子模块，采用Actor-Critic模式确保数据完整性，并通过会话范围的数据持久化机制管理项目生命周期。

### 1.1 域定位与重要性
- **业务定位**: 软件开发流程的起始阶段，为后续设计、规划、编码提供输入
- **重要性评分**: 9.0/10.0（核心业务域）
- **复杂性评分**: 8.0/10.0

### 1.2 技术架构特征
- **开发语言**: Rust
- **异步处理**: 基于async_trait实现异步工具接口
- **数据持久化**: JSON文件存储，会话隔离机制
- **验证机制**: Human-in-the-Loop强制用户评审

## 2. 核心子模块详解

### 2.1 创意代理模块 (Idea Agent)

#### 2.1.1 功能职责
- **创意理解**: 解析用户初始创意输入
- **结构化保存**: 生成标准化的idea.md文档
- **用户评审**: 通过HITL机制确保创意准确性

#### 2.1.2 技术实现
```rust
// 核心指令结构
pub const IDEA_AGENT_INSTRUCTION: &str = r#"
# Your Role
Your job is to understand the user's initial idea, save it to `idea.md`, and let the user review/refine it.
"#;
```

#### 2.1.3 工作流程
1. **理解阶段**: 分析用户创意输入
2. **保存阶段**: 调用`save_idea(content)`保存结构化内容
3. **评审阶段**: 强制调用`review_and_edit_content()`进行用户审核
4. **完成阶段**: 传递至PRD团队

#### 2.1.4 关键约束
- 禁止问答式对话，直接基于理解生成内容
- 必须进行用户评审环节
- 文档格式标准化管理

### 2.2 PRD代理模块 (PRD Agent)

#### 2.2.1 Actor-Critic架构模式
采用双代理协作模式：
- **PRD Actor**: 负责需求创建和文档生成
- **PRD Critic**: 负责质量验证和完整性检查

#### 2.2.2 PRD Actor技术实现
```rust
pub const PRD_ACTOR_INSTRUCTION: &str = r#"
# Your Role
You are PRD Actor. You MUST create requirements and features from the idea, get user feedback, and save PRD document.
"#;
```

**六步强制执行流程**:
1. **加载创意**: 调用`load_idea()`获取项目基础
2. **需求草案**: 生成5-8个需求和3-5个特性的大纲
3. **用户评审**: 强制HITL交互`review_with_feedback_content()`
4. **正式创建**: 逐个调用`create_requirement()`和`add_feature()`
5. **文档保存**: 调用`save_prd_doc()`保存完整PRD
6. **数据验证**: 调用`get_requirements()`确认保存完整性

#### 2.2.3 PRD Critic技术实现
```rust
pub const PRD_CRITIC_INSTRUCTION: &str = r#"
# Your Role  
You are PRD Critic. You MUST verify that PRD Actor completed ALL required steps correctly.
"#;
```

**四大验证检查**:
1. **数据存在性验证**: 检查需求和特性数组非空
2. **制品验证**: 验证prd.md文件存在且完整
3. **数据质量评估**: 检查各字段完整性和合理性
4. **覆盖度分析**: 验证需求对创意范围的完整覆盖

### 2.3 变更分析模块 (Change Triage Agent)

#### 2.3.1 功能定位
负责分析用户变更请求，确定修改范围、影响评估和风险分析。

#### 2.3.2 技术实现
```rust
pub const CHANGE_TRIAGE_INSTRUCTION: &str = r#"
# Role: Change Triage Agent
You are a Change Triage Agent responsible for analyzing user's change requests.
"#;
```

#### 2.3.3 分析维度
1. **范围分析**:
   - PRD更新需求 (`requires_prd_update`)
   - 设计更新需求 (`requires_design_update`) 
   - 计划更新需求 (`requires_plan_update`)
   - 代码变更需求 (`requires_code_change`)

2. **影响分析**:
   - 受影响组件 (`affected_components`)
   - 受影响特性 (`affected_features`)
   - 风险等级 (`risk_level`)
   - 工作量预估 (`estimated_effort`)

3. **验收标准提取**: 从用户请求中提取完成标准
4. **约束识别**: 识别需要保护的现有功能

## 3. 数据模型与持久化

### 3.1 核心数据结构
- **创意数据**: 存储在`idea.md`中的结构化Markdown
- **需求数据**: Requirements数组，包含标题、描述、优先级等字段
- **特性数据**: Features数组，关联需求ID和完成标准
- **变更请求**: ChangeRequest对象，包含范围分析和风险评估

### 3.2 存储机制
- **会话隔离**: 每个项目独立存储空间
- **文件格式**: JSON序列化存储
- **事务完整性**: 原子操作确保数据一致性

## 4. 工具集成与依赖

### 4.1 内部工具依赖
```mermaid
graph LR
   [需求管理域] --> B[文件工具]
    A --> C[数据工具]
    A --> D[验证工具]
    A --> E[控制工具]
    
    B --> F[存储引擎]
    C --> F
```

### 4.2 外部系统集成
- **LLM服务**: 用于智能需求分析和文档生成
- **文本编辑器**: 用于HITL环节的用户编辑
- **版本控制**: 用于变更追踪和历史管理

## 5. 质量保证机制

### 5.1 强制验证点
1. **创意代理**: 用户评审环节强制执行
2. **PRD代理**: 六步流程完整性检查
3. **变更分析**: 多维度风险评估

### 5.2 容错设计
- **HITL介入**: 关键决策点的人类参与
- **数据完整性检查**: 各阶段数据验证
- **错误恢复**: 支持从任意阶段重新开始

## 6. 性能与扩展性

### 6.1 性能特征
- **异步处理**: 非阻塞工具调用
- **增量处理**: 变更分析支持增量更新
- **缓存优化**: 会话数据本地缓存

### 6.2 扩展性设计
- **模块化架构**: 支持新需求类型的扩展
- **工具插件**: 可扩展的分析工具集
- **配置驱动**: 行为参数化配置

## 7. 最佳实践指南

### 7.1 开发规范
- 遵循Actor-Critic模式的设计原则
- 确保所有工具调用的错误处理
- 维护清晰的数据流边界

### 7.2 测试策略
- 单元测试覆盖各工具函数
- 集成测试验证端到端流程
- 性能测试评估大规模需求处理

需求管理域通过严谨的架构设计和质量保证机制，为Cowork Forge系统提供了可靠的需求处理能力，是确保软件开发质量的基础保障。