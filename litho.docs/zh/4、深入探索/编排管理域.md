# 编排管理域技术文档

## 1. 概述

编排管理域是Cowork Forge系统的核心协调模块，负责工作流管道的创建、管理和调度。该模块实现了从创意到交付的完整软件开发流程自动化，支持多种工作流模式，包括新项目创建、中断恢复、阶段跳转和增量修改。

## 2. 核心功能模块

### 2.1 管道编排器（Pipeline Orchestrator）

#### 主要职责
- **工作流编排**：组装不同类型的智能代理到顺序工作流中
- **条件判断**：根据会话状态自动确定工作流起始点
- **错误恢复**：提供灵活的阶段跳转和流程重启机制

#### 核心接口

##### 2.1.1 新项目管道创建
```rust
pub fn create_cowork_pipeline(config: &ModelConfig, session_id: &str) -> Result<Arc<dyn Agent>>
```
**功能描述**：创建完整的软件开发工作流管道，包含7个核心阶段：
1. **创意代理**（IdeaAgent）- 用户创意采集和结构化
2. **PRD循环**（PRD Loop）- 产品需求文档生成和验证（Actor-Critic模式）
3. **设计循环**（Design Loop）- 系统架构设计（Actor-Critic模式）
4. **计划循环**（Plan Loop）- 实现任务规划（Actor-Critic模式）
5. **编码循环**（Coding Loop）- 代码实现（Actor-Critic模式）
6. **检查代理**（Check Agent）- 质量保证
7. **交付代理**（Delivery Agent）- 最终报告生成

##### 2.1.2 恢复管道创建
```rust
pub fn create_resume_pipeline(
    config: &ModelConfig,
    session_id: &str,
    base_session_id: &str,
) -> Result<Arc<dyn Agent>>
```
**智能阶段检测逻辑**：
- **编码阶段恢复**：当基础会话存在实现计划、设计规范和需求文档时
- **计划阶段恢复**：当基础会话存在设计规范和需求文档时  
- **设计阶段恢复**：当基础会话存在需求文档时
- **PRD阶段恢复**：当基础会话只有创意或无数据时

##### 2.1.3 部分管道创建
```rust
pub fn create_partial_pipeline(
    config: &ModelConfig,
    session_id: &str,
    base_session_id: &str,
    start_stage: &str,
) -> Result<Arc<dyn Agent>>
```
**支持阶段**：
- `"prd"` → PRD→设计→计划→编码→检查→交付
- `"design"` → 设计→计划→编码→检查→交付
- `"plan"` → 计划→编码→检查→交付
- `"coding"` → 编码→检查→交付
- `"check"` → 检查→交付
- `"delivery"` → 交付

##### 2.1.4 修改管道创建
```rust
pub fn create_modify_pipeline(
    config: &ModelConfig,
    session_id: &str,
    base_session_id: &str,
) -> Result<Arc<dyn Agent>>
```
**增量修改流程**：
1. **变更分类代理**（Change Triage）- 分析变更范围和影响
2. **代码补丁代理**（Code Patch）- 增量代码修改实施
3. **检查代理**（Check）- 变更验证
4. **修改交付代理**（Modify Delivery）- 变更报告生成

### 2.2 阶段控制模块（Stage Control）

#### 2.2.1 阶段跳转工具（GotoStageTool）
```rust
pub struct GotoStageTool {
    session_id: String,
}
```

**核心功能**：
- **阶段验证**：验证输入阶段的合法性（支持prd、design、plan、coding）
- **会话管理**：更新会话元数据中的当前阶段和重启原因
- **重启调度**：提供用户友好的重启指导信息

**技术实现**：
- 使用JSON Schema定义参数验证规则
- 基于会话ID的元数据持久化管理
- 异步工具执行支持

## 3. 技术架构特点

### 3.1 模块化设计
- **清晰的责任分离**：每个管道类型有独立的创建函数
- **可扩展的代理架构**：支持新代理类型的无缝集成
- **统一的接口设计**：所有管道返回标准化的Agent接口

### 3.2 智能决策机制
- **数据驱动**：基于文件存在状态的智能阶段判断
- **条件组装**：根据实际需求动态构建工作流序列
- **容错处理**：完善的错误处理和恢复机制

### 3.3 会话管理
- **状态持久化**：通过会话元数据跟踪流程状态
- **上下文传递**：确保代理间的数据一致性
- **隔离性保障**：支持多个并发会话的独立管理

## 4. 核心数据结构

### 4.1 会话元数据（SessionMeta）
```rust
struct SessionMeta {
    session_id: String,
    created_at: DateTime<Utc>,
    current_stage: Option<Stage>,
    restart_reason: Option<String>,
}
```

### 4.2 阶段枚举（Stage）
```rust
enum Stage {
    Prd,
    Design,
    Plan,
    Coding,
    Check,
    Delivery,
}
```

## 5. 工作流模式

### 5.1 完整开发流程
```
创意采集 → PRD生成 → 架构设计 → 任务规划 → 代码实现 → 质量检查 → 项目交付
```

### 5.2 增量修改流程  
```
变更分析 → 代码补丁 → 变更验证 → 变更报告
```

### 5.3 流程恢复模式
```
错误检测 → 阶段验证 → 会话恢复 → 管道重建 → 继续执行
```

## 6. 集成依赖

### 6.1 内部依赖
- **代理管理层**：用于创建各类智能代理实例
- **数据存储层**：提供会话状态持久化和文件操作
- **LLM集成层**：提供大语言模型客户端

### 6.2 外部依赖
- **adk-core框架**：提供Agent基础架构和工具支持
- **SequentialAgent**：顺序工作流组装组件

## 7. 错误处理机制

### 7.1 阶段验证错误
- 无效阶段名称的早期检测和拒绝
- 提供清晰的错误消息和有效阶段枚举

### 7.2 文件系统错误
- 基础会话文件不存在时的优雅降级
- 会话元数据读写失败的重试机制

### 7.3 代理创建错误
- LLM客户端初始化失败的传播处理
- 工具注册失败的详细错误信息

## 8. 性能考虑

### 8.1 资源优化
- **LLM客户端复用**：避免重复创建LLM连接
- **代理懒加载**：按需创建代理实例
- **内存管理**：使用Arc实现智能指针共享

### 8.2 并发支持
- **异步执行**：支持高并发工作流执行
- **会话隔离**：确保多用户环境的安全性
- **状态一致性**：保证并发操作的数据完整性

## 9. 扩展性设计

### 9.1 新管道类型支持
- 标准化的管道创建接口
- 灵活的代理组装机制
- 可配置的工作流序列

### 9.2 自定义阶段支持
- 可扩展的阶段枚举定义
- 动态的阶段映射逻辑
- 通用的工具参数验证

## 10. 使用场景示例

### 10.1 新项目开发
```rust
let pipeline = create_cowork_pipeline(&config, "session_123")?;
```

### 10.2 中断恢复
```rust
let pipeline = create_resume_pipeline(&config, "new_session", "base_session")?;
```

### 10.3 阶段重试
```rust
let pipeline = create_partial_pipeline(&config, "session_123", "base_session", "design")?;
```

### 10.4 增量修改
```rust
let pipeline = create_modify_pipeline(&config, "modify_session", "base_session")?;
```

## 总结

编排管理域作为Cowork Forge系统的核心协调层，通过精密的管道编排和智能的阶段管理，实现了软件开发流程的高效自动化。该模块的模块化设计、智能决策机制和强大的错误恢复能力，为开发团队提供了灵活可靠的开发编排工具。