# Cowork Forge 数据存储域技术文档

## 1. 概述

数据存储域是Cowork Forge系统的核心基础设施组件，负责整个系统的数据持久化、会话管理和文件存储架构。该模块实现了基于文件系统的会话隔离存储系统，为软件开发流程的各个阶段提供可靠的数据支持。

## 2. 架构设计

### 2.1 整体架构
数据存储域采用分层架构设计，包含两个核心模块：
- **存储引擎模块** (`storage/mod.rs`)：提供文件系统操作接口和会话管理
- **数据模型模块** (`data/models.rs`)：定义系统的结构化数据模型

### 2.2 目录结构设计
系统采用标准化的目录结构来组织数据：

```
.cowork/                    # 项目根目录
├── index.json              # 项目索引文件
└── sessions/               # 会话目录
    └── <session_id>/       # 单个会话目录
        ├── input.json      # 会话输入信息
        ├── artifacts/      # 文档存储
        │   ├── idea.md     # 创意文档
        │   ├── prd.md      # 产品需求文档
        │   ├── design.md   # 设计文档
        │   └── delivery_report.md  # 交付报告
        ├── state/          # 状态数据
        │   ├── requirements.json   # 需求数据
        │   ├── feature_list.json   # 功能列表
        │   ├── design_spec.json    # 设计规格
        │   ├── implementation_plan.json  # 实现计划
        │   ├── code_metadata.json  # 代码元数据
        │   ├── feedback.json       # 反馈历史
        │   └── meta.json           # 会话元数据
        ├── patch/          # 补丁数据（修改会话）
        │   └── metadata.json       # 补丁元数据
        └── logs/           # 日志文件
```

## 3. 核心组件

### 3.1 存储引擎模块

#### 3.1.1 目录管理功能
```rust
// 核心目录操作函数
pub fn get_cowork_dir() -> Result<PathBuf>        // 获取.cowork目录路径
pub fn get_session_dir(session_id: &str) -> Result<PathBuf>  // 获取会话目录
pub fn get_project_root() -> Result<PathBuf>      // 获取项目根目录
```

#### 3.1.2 项目索引管理
```rust
// 项目级别状态管理
pub fn load_project_index() -> Result<ProjectIndex>
pub fn save_project_index(index: &ProjectIndex) -> Result<()>
pub fn init_project_index(project_name: String) -> Result<ProjectIndex>
```

#### 3.1.3 会话管理
```rust
// 会话生命周期管理
pub fn save_session_input(session_id: &str, input: &SessionInput) -> Result<()>
pub fn load_session_input(session_id: &str) -> Result<SessionInput>
pub fn mark_session_completed(session_id: &str) -> Result<()>
pub fn mark_session_failed(session_id: &str) -> Result<()>
```

#### 3.1.4 状态数据管理
```rust
// 各阶段状态数据管理
pub fn save_requirements(session_id: &str, requirements: &Requirements) -> Result<()>
pub fn load_requirements(session_id: &str) -> Result<Requirements>
pub fn save_design_spec(session_id: &str, design: &DesignSpec) -> Result<()>
pub fn load_design_spec(session_id: &str) -> Result<DesignSpec>
// ... 类似函数支持所有状态文件
```

#### 3.1.5 会话继承机制
```rust
// 关键会话继承功能
pub fn init_session_from_base(new_session_id: &str, base_session_id: &str) -> Result<()>
```
该机制支持`modify`、`revert`、`resume`工作流，通过复制基础会话的状态文件和文档文件实现会话继承。

### 3.2 数据模型模块

#### 3.2.1 需求管理模型
```rust[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Requirements {
    pub schema_version: String,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
    pub requirements: Vec<Requirement>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Requirement {
    pub id: String,           // REQ-001格式
    pub title: String,
    pub description: String,
    pub priority: Priority,   // High/Medium/Low
    pub category: RequirementCategory, // Functional/NonFunctional
    pub acceptance_criteria: Vec<String>,
    pub related_features: Vec<String>,
}
```

#### 3.2.2 功能特性模型
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct FeatureList {
    pub schema_version: String,
    pub features: Vec<Feature>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Feature {
    pub id: String,           // FEAT-001格式
    pub name: String,
    pub description: String,
    pub requirement_ids: Vec<String>,
    pub status: FeatureStatus, // Pending/InProgress/Completed/Blocked
    pub assigned_to_tasks: Vec<String>,
    pub completion_criteria: Vec<String>,
    pub metadata: FeatureMetadata,
}
```

#### 3.2.3 设计规格模型
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DesignSpec {
    pub schema_version: String,
    pub architecture: Architecture,
    pub technology_stack: TechnologyStack,
    pub deployment: DeploymentInfo,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Architecture {
    pub style: String,        // "microservices", "monolith"等
    pub components: Vec<DesignComponent>,
    pub data_models: Vec<DataModel>,
}
```

#### 3.2.4 实现计划模型
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ImplementationPlan {
    pub schema_version: String,
    pub milestones: Vec<Milestone>,
    pub tasks: Vec<Task>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Task {
    pub id: String,           // TASK-001格式
    pub title: String,
    pub description: String,
    pub feature_id: String,
    pub component_id: String,
    pub status: TaskStatus,   // Pending/InProgress/Completed/Blocked
    pub dependencies: Vec<String>,
    pub files_to_create: Vec<String>,
    pub acceptance_criteria: Vec<String>,
}
```

#### 3.2.5 代码元数据模型
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CodeMetadata {
    pub schema_version: String,
    pub files: Vec<FileMetadata>,
    pub build_status: BuildStatus,
    pub test_status: TestStatus,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct FileMetadata {
    pub path: String,
    pub task_id: String,
    pub feature_id: Option<String>,
    pub component_id: Option<String>,
    pub lines_of_code: usize,
    pub test_coverage: f32,
}
```

#### 3.2.6 会话管理模型
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ProjectIndex {
    pub schema_version: String,
    pub project_name: String,
    pub latest_successful_session: Option<String>,
    pub sessions: Vec<SessionRecord>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SessionRecord {
    pub session_id: String,
    pub session_type: SessionType,    // New/Modify/Revert
    pub status: SessionStatus,        // InProgress/Completed/Failed
    pub base_session_id: Option<String>,
    pub input_description: String,
}
```

#### 3.2.7 变更管理模型
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ChangeRequest {
    pub id: String,
    pub session_id: String,
    pub idea: String,
    pub base_session_id: String,
    pub scope: ChangeScope,
    pub acceptance_criteria: Vec<String>,
    pub constraints: Vec<String>,
    pub analysis: Option<ChangeAnalysis>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ChangeScope {
    pub requires_prd_update: bool,
    pub requires_design_update: bool,
    pub requires_plan_update: bool,
    pub requires_code_change: bool,
}
```

## 4. 关键技术特性

### 4.1 数据序列化
- 使用`serde`库进行JSON序列化/反序列化
- 支持`serde_json::to_string_pretty`美化输出
- 自动处理时间戳字段的序列化

### 4.2 错误处理
- 使用`anyhow::Result`统一错误处理
- 详细的错误上下文信息
- 文件不存在时的优雅降级处理

### 4.3 会话隔离
- 每个会话拥有独立的目录结构
- 状态数据严格隔离，避免会话间污染
- 支持会话继承，实现工作流连续性

### 4.4 事务完整性
- 文件写入操作具有原子性
- 支持状态文件的存在性检查
- 提供完整的CRUD操作接口

## 5. 工作流集成

### 5.1 新项目创建流程
1. 调用`init_project_index()`初始化项目索引
2. 创建新会话目录结构
3. 保存会话输入信息
4. 按阶段保存状态数据

### 5.2 增量修改流程
1. 调用`init_session_from_base()`基于现有会话创建新会话
2. 加载基础会话的状态数据
3. 保存变更请求信息
4. 增量更新相关状态文件

### 5.3 流程恢复机制
1. 通过`load_project_index()`获取项目状态
2. 加载指定会话的状态数据
3. 使用`goto_stage_tool`重新组装工作流
4. 从断点继续执行

## 6. 性能优化

### 6.1 文件操作优化
- 懒加载策略：仅在需要时读取文件
- 批量操作支持：减少文件I/O次数
- 路径缓存：避免重复路径计算

### 6.2 内存管理
- 使用Rust的所有权系统避免内存泄漏
- 及时释放文件句柄
- 合理的序列化大小控制

## 7. 可靠性保障

### 7.1 错误恢复
- 文件不存在时的默认值返回
- 损坏文件的优雅处理
- 备份和恢复机制

### 7.2 数据一致性
- 版本控制：所有模型包含schema_version
- 时间戳跟踪：记录创建和更新时间
- 完整性校验：关键字段的非空验证

## 8. 扩展性设计

### 8.1 模型扩展
- 使用Optional字段支持向后兼容
- 枚举类型支持新值添加
- 元数据字段支持自定义扩展

### 8.2 存储后端扩展
- 抽象的文件操作接口
- 支持多种序列化格式
- 可替换的存储引擎实现

## 9. 总结

数据存储域作为Cowork Forge系统的核心基础设施，提供了可靠、高效的数据持久化解决方案。通过精心设计的目录结构、完善的数据模型和健壮的错误处理机制，该模块为整个软件开发编排系统提供了坚实的数据基础。其会话隔离、事务完整性和扩展性设计确保了系统能够支持复杂的软件开发工作流需求。