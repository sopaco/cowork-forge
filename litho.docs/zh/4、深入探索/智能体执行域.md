# 智能体执行域技术文档

## 模块概述

智能体执行域是 Cowork Forge 系统的核心执行引擎，负责实例化、调用与管理各类 LLM 智能体的运行时行为。该域通过智能体构建器工厂创建智能体实例，并通过人机交互封装实现容错执行机制，确保开发流程的鲁棒性和可控性。

## 核心组件架构

### 1. 智能体构建器 (agents/mod.rs)

#### 1.1 模块设计理念
- **工厂模式**：提供统一的智能体创建接口，封装复杂的 LLM Agent 构建逻辑
- **工具绑定**：为每个智能体精确配置所需的工具集，确保功能完整性
- **循环优化**：通过 `max_iterations` 机制替代 `exit_loop` 工具，解决 SequentialAgent 提前终止的关键缺陷

#### 1.2 智能体类型与配置

##### IdeaAgent（单智能体）
```rust
pub fn create_idea_agent(model: Arc<dyn Llm>, session_id: &str) -> Result<Arc<dyn Agent>>
```
- **功能**：捕获并结构化用户初始想法
- **工具集**：SaveIdeaTool、LoadIdeaTool、ReviewAndEditContentTool
- **特点**：单次执行，无循环机制

##### Actor-Critic 循环智能体（PRD/Design/Plan/Coding）
```rust
pub fn create_prd_loop(model: Arc<dyn Llm>, session_id: &str) -> Result<Arc<dyn Agent>>
```
- **架构模式**：Actor（执行）+ Critic（评审）的评审循环机制
- **迭代控制**：通过 LoopAgent 包装，设置最大迭代次数（PRD/Design/Plan: 3次，Coding: 5次）
- **容错包装**：所有循环智能体均通过 ResilientAgent 包装，实现错误恢复

##### 检查与交付智能体（Check/Delivery）
```rust
pub fn create_check_agent(model: Arc<dyn Llm>, session_id: &str) -> Result<Arc<dyn Agent>>
```
- **功能定位**：质量保证和最终产物生成
- **工具特点**：包含完整的验证工具集和交付工具集

#### 1.3 关键技术实现

**循环机制优化**
```rust
// 关键修复：使用 max_iterations 替代 exit_loop 工具
let mut loop_agent = LoopAgent::new("prd_loop",[actor, critic]);
loop_agent = loop_agent.with_max_iterations(3); // 允许最多3次尝试
```

**工具绑定策略**
- **数据操作工具**：Save/Load 工具绑定特定会话 ID
- **文件操作工具**：ReadFileTool、WriteFileTool、ListFilesTool
- **交互工具**：ReviewAndEditContentTool、ProvideFeedbackTool
- **验证工具**：CheckFeatureCoverageTool、CheckTaskDependenciesTool

### 2. 人机交互封装 (agents/hitl.rs)

#### 2.1 ResilientAgent 设计

**核心职责**
- 拦截智能体执行过程中的错误
- 提供用户交互界面进行错误恢复决策
- 支持智能体重试和流程继续

**实现架构**
```rust
pub struct ResilientAgent {
    inner: Arc<dyn Agent>,    // 被包装的原始智能体
    subs: Vec<Arc<dyn Agent>>, // 子智能体列表
}
```

**错误处理流程**
1. **错误检测**：拦截包含 "Max iterations" 的错误信息
2. **用户交互**：通过 dialoguer 库提供 CLI 交互界面
3. **恢复选项**：
   - **重试**：重置计数器重新执行
   - **提供指导**：用户输入指导信息后重试
   - **中止**：终止当前流程

#### 2.2 ResilientStream 异步流处理

**状态管理**
```rust
enum StreamState {
    Streaming(AgentOutput),  // 正常流式执行
    Retrying(Future)         // 重试状态
}
```

**流式错误处理机制**
1. **事件轮询**：通过 `poll_next` 方法处理流式事件
2. **错误拦截**：在流处理过程中实时检测错误
3. **状态转换**：根据用户选择切换 Streaming/Retrying 状态
4. **递归重试**：支持无限次重试，直到用户选择中止

## 技术实现细节

### 3.1 智能体构建技术栈

**依赖框架**
- **adk-rust**：基于该框架构建 LLM Agent
- **LlmAgentBuilder**：智能体构建器，支持指令、模型、工具配置
- **LoopAgent**：实现智能体循环执行机制

**配置参数**
- **IncludeContents::None**：不包含额外上下文内容
- **模型共享**：Actor 和 Critic 共享同一模型实例
- **会话隔离**：通过 session_id 确保多会话数据隔离

### 3.2 错误恢复机制

**同步错误处理**
```rust
async fn handle_error(&self, context: Arc<dyn InvocationContext>, e: AdkError) 
```

**异步流错误处理**
```rust
impl Stream for ResilientStream {
    fn poll_next(...) -> Poll<Option<Self::Item>>
}
```

**用户交互界面**
```rust
let selection = Select::with_theme(&ColorfulTheme::default())
    .with_prompt("How would you like to proceed?")
    .items(&["Retry", "Provide Guidance & Retry", "Abort"])
    .interact()
```

## 模块间协作关系

### 4.1 与智能体指令域的协作
- **依赖关系**：导入 instructions 模块中的指令模板
- **数据流**：将静态指令转化为动态执行逻辑
- **质量控制**：通过 Actor-Critic 模式确保输出符合指令要求

### 4.2 与工具执行域的协作
- **工具调用**：智能体通过 Tool trait 调用各类工具
- **数据持久化**：通过数据工具与会话存储域交互
- **文件操作**：通过文件工具与本地文件系统交互

### 4.3 与 LLM 集成域的协作
- **模型配置**：依赖 LLM 配置创建模型客户端
- **速率控制**：通过速率限制器确保 API 调用稳定性

## 性能与可靠性设计

### 5.1 容错机制
- **最大迭代限制**：防止无限循环，PRD/Design/Plan 3次，Coding 5次
- **错误恢复**：通过 ResilientAgent 实现自动错误恢复
- **用户介入**：关键错误时请求用户决策，确保流程可控

### 5.2 异步处理
- **非阻塞执行**：基于 async/await 的异步流处理
- **状态管理**：通过 StreamState 管理执行状态转换
- **资源优化**：使用 Arc 共享智能体实例，减少内存占用

### 5.3 可扩展性设计
- **工厂模式**：支持新增智能体类型的快速集成
- **工具插件**：通过 Tool trait 支持工具的动态扩展
- **配置驱动**：智能体行为可通过配置参数灵活调整

## 使用场景与最佳实践

### 6.1 典型使用场景

**全新项目创建流程**
```rust
let idea_agent = create_idea_agent(model, session_id)?;
let prd_loop = create_prd_loop(model, session_id)?;
// ... 其他智能体依次执行
```

**增量修改流程**
```rust
// 根据变更范围选择回退点
let coding_loop = create_coding_loop(model, session_id)?;
```

**错误恢复场景**
- 当智能体达到最大迭代次数时自动触发恢复机制
- 用户可选择重试、提供指导或中止流程

### 6.2 配置建议

**迭代次数配置**
- **需求/设计阶段**：3次迭代平衡质量与效率
- **编码阶段**：5次迭代应对复杂代码实现
- **检查阶段**：单次执行确保效率

**工具选择策略**
- 根据智能体职责精确配置工具集
- 避免过度工具绑定影响性能
- 确保工具间的数据流一致性

## 总结

智能体执行域作为 Cowork Forge 系统的执行引擎，通过精巧的架构设计实现了 LLM 智能体的高效、可靠执行。其核心价值在于：

1. **标准化执行**：提供统一的智能体构建和执行接口
2. **容错保障**：通过 ResilientAgent 实现强大的错误恢复能力  
3. **人机协作**：支持人类在关键节点的介入和指导
4. **性能优化**：通过异步流处理和状态管理确保执行效率

该模块的成功实现为整个系统的自动化开发流程提供了坚实的技术基础，是 Cowork Forge 实现"最小可行架构"理念的关键支撑。