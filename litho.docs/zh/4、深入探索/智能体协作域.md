# 智能体协作域技术文档

## 文档概述

**智能体协作域**是Cowork Forge系统的核心业务域，负责构建和管理各类AI智能体实例，通过Actor-Critic协作模式实现从需求分析到代码交付的完整AI辅助开发流程。本文档基于系统研究材料，详细阐述该域的技术实现架构、核心组件和工作原理。

---

## 1. 域模块概览

### 1.1 定义与作用
智能体协作域是系统中AI智能体的集中管理模块，采用分层设计实现智能体的创建、配置和执行。该域通过标准化接口封装智能体协作逻辑，为工作流引擎提供可复用的智能体服务。

### 1.2 核心价值
- **降低开发门槛**：通过AI智能体自动化编码任务，减少人工工作量
- **提高协作效率**：采用Actor-Critic模式实现智能体间的迭代优化
- **保障质量可控**：集成HITL（人类参与循环）机制确保输出质量
- **支持灵活扩展**：模块化设计支持新智能体的快速集成

### 1.3 技术特征
- **架构模式**：基于adk-rust框架的LlmAgentBuilder
- **协作机制**：Actor-Critic循环迭代模式
- **容错设计**：ResilientAgent错误恢复机制
- **集成方式**：通过会话ID实现数据共享和状态管理

---

## 2. 核心组件分析

### 2.1 智能体构建器（Agent Builder）
**代码路径**：`crates/cowork-core/src/agents/mod.rs`

智能体构建器是域的核心组件，负责创建7类标准智能体实例：

| 智能体类型 | 功能描述 | 协作模式 | 最大迭代次数 |
|-----------|----------|----------|-------------|
| Idea智能体 | 项目创意收集和整理 | 单次执行 | 1 |
| PRD循环智能体 | 产品需求文档生成和验证 | Actor-Critic循环 | 3 |
| Design循环智能体 | 系统架构设计生成和评审 | Actor-Critic循环 | 3 |
| Plan循环智能体 | 实现任务规划和验证 | Actor-Critic循环 | 3 |
| Coding循环智能体 | 代码生成和补丁管理 | Actor-Critic循环 | 3 |
| Check智能体 | 质量检查和验证 | 单次执行 | 1 |
| Delivery智能体 | 交付报告生成 | 单次执行 | 1 |

**技术实现**：
```rust
// 智能体创建函数示例
pub fn create_prd_agent(session: Arc<Mutex<Session>>) -> Arc<dyn Agent> {
    let prd_actor = LlmAgentBuilder::new("prd_actor")
        .instruction(prd_actor_instruction())
        .tool(Arc::new(CreateRequirementTool::new(session.clone())))
        .build();
    
    let prd_critic = LlmAgentBuilder::new("prd_critic")
        .instruction(prd_critic_instruction())
        .tool(Arc::new(ValidateRequirementTool::new(session.clone())))
        .build();
    
    let mut loop_agent = LoopAgent::new("prd_loop", vec![Arc::new(prd_actor), Arc::new(prd_critic)]);
    loop_agent = loop_agent.with_max_iterations(3);
    
    Arc::new(ResilientAgent::new(loop_agent))
}
```

### 2.2 指令管理器（Instruction Manager）
**代码路径**：`crates/cowork-core/src/instructions/mod.rs`

指令管理器统一管理所有智能体的提示词模板和指令配置：

**核心功能**：
- 指令模板的集中存储和管理
- 基于业务场景的动态指令生成
- 多语言指令支持（中英文）
- 指令版本控制和更新机制

**指令分类**：
- **创意指令**：项目创意收集和可行性分析
- **需求指令**：PRD文档生成和需求验证
- **设计指令**：系统架构设计和评审标准
- **规划指令**：任务分解和依赖管理
- **编码指令**：代码生成规范和最佳实践
- **检查指令**：质量标准和验证规则
- **交付指令**：报告模板和验收标准

### 2.3 HITL智能体（Human-in-the-Loop Agent）
**代码路径**：`crates/cowork-core/src/agents/hitl.rs`

HITL智能体实现人类参与循环机制，确保关键决策点的人工干预：

**核心特性**：
- **错误恢复机制**：通过ResilientAgent包装器实现故障自动恢复
- **用户交互接口**：提供审核、编辑、反馈等交互工具
- **决策点管理**：在关键质量节点暂停等待用户输入
- **流程控制**：支持继续执行、重新执行或中止流程

**实现模式**：
```rust
pub struct ResilientAgent {
    inner_agent: Arc<dyn Agent>,
    max_retries: usize,
    recovery_strategy: RecoveryStrategy,
}

impl Agent for ResilientAgent {
    fn execute(&self, context: &mut Context) -> Result<Output, Error> {
        // 实现错误恢复逻辑
        // 集成HITL交互工具
    }
}
```

---

## 3. 架构设计与协作模式

### 3.1 Actor-Critic协作模式

智能体协作域采用标准的Actor-Critic架构模式：

**Actor角色**：
- 负责核心业务逻辑执行（如文档生成、代码编写）
- 调用工具系统完成具体操作
- 产出初步结果供Critic评审

**Critic角色**：
- 对Actor输出进行质量评估
- 提供改进反馈和建议
- 决定是否通过或要求重新执行

**迭代流程**：
1. Actor生成初始输出
2. Critic进行质量评审
3. 若未通过，提供具体反馈
4. Actor基于反馈改进输出
5. 重复直到达到质量标准或最大迭代次数

### 3.2 数据流设计

智能体间通过共享会话ID实现数据传递和状态同步：

```
用户输入 → 工作流引擎 → 智能体构建器 → 智能体实例 → 工具调用 → 数据存储
```

**关键数据流**：
- **会话状态**：通过session_id在智能体间传递上下文
- **工件数据**：需求文档、设计图、代码文件等中间产物
- **反馈信息**：Critic提供的改进建议和质量评估
- **控制信号**：循环退出条件、错误处理指令

### 3.3 工具集成机制

智能体通过工具系统与外部资源交互：

**集成方式**：
- 工具注册：每个智能体配置专用的工具集
- 权限控制：基于智能体角色的工具访问权限
- 结果处理：工具执行结果的标准化解析
- 错误处理：工具调用异常的统一处理机制

---

## 4. 工作流集成

### 4.1 在主工作流中的角色

智能体协作域作为工作流引擎的核心执行单元：

**完整项目开发流程集成**：
```
创意阶段 → Idea智能体
需求阶段 → PRD循环智能体（Actor-Critic）
设计阶段 → Design循环智能体（Actor-Critic）  
规划阶段 → Plan循环智能体（Actor-Critic）
编码阶段 → Coding循环智能体（Actor-Critic）
检查阶段 → Check智能体
交付阶段 → Delivery智能体
```

### 4.2 特殊工作流支持

**项目修改工作流**：
- 变更分析智能体：分析修改范围和影响
- 代码补丁智能体：生成增量修改代码
- 修改交付智能体：生成变更报告

**项目恢复工作流**：
- 会话状态智能体：加载历史会话数据
- 阶段跳转智能体：从指定阶段继续执行

---

## 5. 技术实现细节

### 5.1 框架依赖
- **adk-rust**：基础智能体框架
- **LlmAgentBuilder**：LLM智能体构建工具
- **LoopAgent**：循环执行控制器
- **ResilientAgent**：容错包装器

### 5.2 配置管理
每个智能体支持以下配置参数：
- **指令模板**：业务特定的提示词配置
- **工具集合**：可访问的功能工具列表
- **迭代参数**：最大迭代次数、超时设置
- **质量阈值**：Critic评审的通过标准

### 5.3 错误处理机制
**多层容错设计**：
1. **工具级容错**：工具调用的异常捕获和重试
2. **智能体级容错**：ResilientAgent的错误恢复策略
3. **工作流级容错**：阶段执行失败的整体处理
4. **用户级容错**：HITL机制的人工干预选项

---

## 6. 性能与优化

### 6.1 性能特征
- **并发处理**：支持多个智能体并行执行
- **内存管理**：会话数据的智能缓存和清理
- **API优化**：LLM调用的速率限制和批量处理

### 6.2 扩展性设计
- **插件架构**：新智能体的标准接入接口
- **配置驱动**：基于配置文件的智能体行为定制
- **模板系统**：可复用的指令和工具配置模板

---

## 7. 总结

智能体协作域作为Cowork Forge系统的AI核心，通过先进的Actor-Critic协作模式和HITL机制，实现了智能化、可控的软件开发辅助流程。该域的设计充分体现了模块化、可扩展和容错性的现代软件架构理念，为AI辅助开发提供了坚实的技术基础。

**核心优势**：
1. **智能化程度高**：基于LLM的智能决策和内容生成
2. **协作效率优**：多智能体间的无缝协作和迭代优化
3. **质量控制严**：多层次评审和人工干预机制
4. **扩展性强**：标准化的接口和配置驱动架构

该域的成功实践为类似AI辅助开发系统提供了可复用的架构模式和实现参考。