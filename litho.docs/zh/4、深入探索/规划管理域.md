# 规划管理域技术文档

## 1. 模块概述

### 1.1 核心职责
规划管理域是Cowork Forge系统中的核心业务域之一，负责实现任务规划、依赖分析、任务分配和计划验证等功能。该域在新项目开发流程中处于关键位置，承接设计管理域输出的架构设计，为编码实施域提供详细的实现指导。

### 1.2 业务价值
- **任务分解**: 将复杂的架构设计分解为可执行的编码任务
- **依赖管理**: 识别和管理任务间的依赖关系，避免循环依赖
- **质量保证**: 通过Actor-Critic模式确保规划质量
- **资源协调**: 为后续编码阶段提供清晰的执行路径

## 2. 架构设计

### 2.1 模块组成
规划管理域采用双模块架构设计：

#### 2.1.1 规划代理模块 (`plan.rs`)
- **位置**: `crates/cowork-core/src/instructions/plan.rs`
- **大小**: 5,112字节，132行代码
- **核心功能**: 实现Actor-Critic模式的智能规划代理

#### 2.1.2 依赖分析模块 (`validation_tools.rs`)
- **位置**: `crates/cowork-core/src/tools/validation_tools.rs`
- **核心功能**: 依赖关系验证和循环检测

### 2.2 数据模型
规划管理域的核心数据模型定义在`models.rs`中：

```rust[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ImplementationPlan {
    pub schema_version: String,
    pub tasks: Vec<Task>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Task {
    pub id: String,           // TASK-001, TASK-002等
    pub title: String,
    pub description: String,
    pub feature_id: String,   // 关联的功能ID
    pub component_id: String, // 关联的组件ID
    pub status: TaskStatus,
    pub dependencies: Vec<String>, // 依赖的任务ID
    pub estimated_effort: Option<String>,
    pub files_to_create: Option<Vec<String>>,
    pub acceptance_criteria: Vec<String>,
    pub created_at: DateTime<Utc>,
    pub completed_at: Option<DateTime<Utc>>,
}
```

## 3. 核心实现机制

### 3.1 Actor-Critic模式
规划管理域采用Actor-Critic双角色架构，确保规划质量：

#### 3.1.1 Actor角色 (`PLAN_ACTOR_INSTRUCTION`)
**核心职责**: 创建实现任务草案并收集用户反馈

**执行流程**:
1. **设计加载**: 调用`get_design()`加载架构组件
2. **任务草案创建**: 生成5-15个实现任务的Markdown草案
3. **用户评审(HITL)**: 通过`review_with_feedback_content()`获取用户反馈
4. **正式任务创建**: 为每个任务调用`create_task()`工具
5. **最终验证**: 调用`get_plan()`确认任务创建成功

**关键约束**:
- MUST检查设计组件是否为空
- MUST调用用户评审步骤
- MUST为每个任务调用创建工具

#### 3.1.2 Critic角色 (`PLAN_CRITIC_INSTRUCTION`)
**核心职责**: 验证Actor工作的完整性和质量

**验证检查点**:
1. **任务数据存在性**: 确认创建了5-15个任务
2. **依赖关系验证**: 检查循环依赖和依赖有效性
3. **功能覆盖率**: 确保所有功能都有对应任务
4. **数据质量评估**: 验证任务信息的完整性

**失败处理策略**:
- 空任务数组 = 严重失败
- 循环依赖 = 严重失败  
- 功能未覆盖 = 严重失败

### 3.2 工具集成

#### 3.2.1 任务创建工具 (`CreateTaskTool`)
```rust
pub struct CreateTaskTool {
    session_id: String,
}

impl Tool for CreateTaskTool {
    fn name(&self) -> &str { "create_task" }
    
    fn parameters_schema(&self) -> Option<Value> {
        Some(json!({
            "type": "object",
            "properties": {
                "title": {"type": "string"},
                "description": {"type": "string"},
                "feature_id": {"type": "string"},
                "component_id": {"type": "string"},
                "files_to_create": {"type": "array", "items": {"type": "string"}},
                "dependencies": {"type": "array", "items": {"type": "string"}},
                "acceptance_criteria": {"type": "array", "items": {"type": "string"}}
            },
            "required": ["title", "description", "feature_id", "component_id", "acceptance_criteria"]
        }))
    }
}
```

#### 3.2.2 依赖检查工具 (`CheckTaskDependenciesTool`)
实现深度优先搜索(DFS)算法进行循环依赖检测，确保任务依赖图的合理性。

## 4. 工作流程

### 4.1 正常规划流程
```mermaid
sequenceDiagram
    participant User as 用户
    participant Actor as Actor代理
    participant Critic as Critic代理
    participant DataTools as 数据工具
    participant ValidTools as 验证工具
    
    User->>Actor: 提供设计输入
    Actor->>DataTools: 加载设计规范
    DataTools-->>Actor: 返回设计数据
    Actor->>Actor: 创建任务草案
    Actor->>User: 提交草案评审(HITL)
    User->>Actor: 提供反馈/编辑
    Actor->>DataTools: 创建正式任务
    DataTools-->>Actor: 确认任务创建
    Actor->>Critic: 提交验证请求
    Critic->>ValidTools: 检查依赖关系
    ValidTools-->>Critic: 返回验证结果
    Critic->>ValidTools: 检查功能覆盖率
    ValidTools-->>Critic: 返回覆盖率结果
    Critic->>User: 输出最终验证结果
```

### 4.2 错误恢复机制
当规划过程出现问题时，系统提供多层恢复策略：

1. **HITL介入**: 用户可以直接编辑任务草案
2. **迭代优化**: Actor根据Critic反馈最多进行3次迭代
3. **阶段重试**: 支持从规划阶段重新开始工作流

## 5. 技术特性

### 5.1 数据完整性保证
- **强类型约束**: 基于Rust的强类型系统确保数据一致性
- **模式验证**: 通过JSON Schema验证数据格式
- **依赖检查**: 自动检测和防止循环依赖

### 5.2 用户体验优化
- **渐进式反馈**: 分步骤展示规划进度
- **可视化草案**: 使用Markdown格式展示任务计划
- **灵活交互**: 支持编辑、通过、反馈三种交互模式

### 5.3 可扩展性设计
- **模块化工具**: 每个功能点都封装为独立工具
- **配置驱动**: 通过指令模板配置代理行为
- **标准接口**: 提供统一的工具调用接口

## 6. 质量保证机制

### 6.1 验证检查清单
规划管理域实施严格的质量检查：

1. **完整性检查**: 确认所有设计组件都有对应任务
2. **一致性检查**: 任务与功能、组件的关联关系正确
3. **可行性检查**: 任务依赖关系合理且无循环
4. **可执行性检查**: 每个任务都有明确的验收标准

### 6.2 容错处理
- **空设计处理**: 检测到空组件时立即中止流程
- **无效依赖处理**: 自动识别并报告循环依赖
- **数据丢失处理**: 验证数据持久化状态

## 7. 集成关系

### 7.1 上游依赖
- **设计管理域**: 提供架构设计作为规划输入
- **需求管理域**: 提供功能需求作为任务分配依据

### 7.2 下游服务
- **编码实施域**: 接收详细的任务计划进行代码实现
- **交付管理域**: 提供任务完成状态用于进度跟踪

### 7.3 支撑服务
- **数据存储域**: 提供任务数据的持久化存储
- **工具支持域**: 提供验证和数据分析工具

## 8. 性能考量

### 8.1 时间复杂度
- 任务创建: O(n)，n为任务数量
- 依赖检查: O(n + e)，n为任务数量，e为依赖边数
- 覆盖率验证: O(n × m)，n为任务数量，m为功能数量

### 8.2 空间复杂度
- 任务存储: O(n)，线性增长
- 依赖图存储: O(n + e)，依赖关系图存储

## 9. 最佳实践

### 9.1 任务规划原则
1. **粒度适中**: 每个任务应在4-8小时内完成
2. **依赖最小化**: 尽量减少任务间的依赖关系
3. **验收明确**: 每个任务必须有清晰的验收标准
4. **资源匹配**: 任务复杂度与开发资源相匹配

### 9.2 质量控制建议
1. **早期验证**: 在规划阶段尽早进行质量检查
2. **用户参与**: 充分利用HITL机制获取用户反馈
3. **迭代优化**: 基于Critic反馈进行多轮优化
4. **文档完整**: 确保所有决策都有完整记录

规划管理域通过智能化的任务分解和质量控制机制，为软件开发团队提供了可靠的项目规划支持，确保从设计到实现的平滑过渡。