# Cowork Forge 工具功能域技术文档

## 1. 模块概述

工具功能域是 Cowork Forge 系统的核心功能实现层，为智能体工作流域提供具体的操作能力支持。该域包含11个子模块，共计11个工具文件，总代码量103KB，采用Rust语言实现，基于async_trait异步框架。

### 1.1 核心架构特点
- **模块化设计**：每个工具独立实现，通过标准化接口统一管理
- **会话隔离**：支持多项目并行开发，数据操作基于session_id隔离
- **安全防护**：文件操作实现路径安全验证和目录遍历防护
- **异步支持**：全工具支持异步执行，提高系统并发性能

## 2. 模块组件详细分析

### 2.1 文件操作模块 (`file_tools.rs` - 16.2KB)
**功能职责**：提供安全的文件系统操作能力，包含路径安全验证机制

**核心工具**：
- **ListFilesTool**：目录文件列表工具，支持递归搜索和深度控制
- **ReadFileTool**：安全文件读取工具，支持行范围读取
- **WriteFileTool**：文件写入工具，包含冲突检测机制
- **RunCommandTool**：命令执行工具，支持安全参数验证

**安全机制**：
```rust
fn validate_path_security(path: &str) -> Result<PathBuf, String> {
    // 1. 拒绝绝对路径访问
    // 2. 防止目录遍历攻击 (..)
    // 3. 路径规范化验证
}
```

### 2.2 数据管理模块 (`data_tools.rs` - 33.6KB)
**功能职责**：结构化数据的创建、修改和质量检查

**核心工具**：
- **CreateRequirementTool**：需求创建工具，支持SMART原则验证
- **AddFeatureTool**：功能特性管理工具
- **CreateDesignComponentTool**：设计组件创建工具
- **CreateTaskTool**：任务规划工具
- **UpdateStatusTools**：状态更新工具集

**数据模型支持**：
```rust
pub struct CreateRequirementTool {
    session_id: String,  // 会话隔离标识
}

// 支持的需求优先级和分类
enum Priority { High, Medium, Low }
enum RequirementCategory { Functional, NonFunctional }
```

### 2.3 流程控制模块 (`control_tools.rs` - 11KB)
**功能职责**：工作流控制和用户交互管理

**核心工具**：
- **ProvideFeedbackTool**：用户反馈收集工具
- **RequestReplanningTool**：重规划请求工具
- **AskUserTool**：用户交互确认工具
- **GotoStageTool**：阶段跳转工具

**交互模式**：
```rust
// 基于dialoguer库的用户交互界面
let confirmed = Confirm::new()
    .with_prompt("是否需要重新规划？")
    .interact()?;
```

### 2.4 人机交互模块 (`hitl_tools.rs`, `hitl_content_tools.rs`)
**功能职责**：Human-in-the-Loop交互支持，提供内容审查和编辑功能

**核心工具**：
- **ReviewAndEditFileTool**：文件内容审查编辑工具
- **ReviewAndEditContentTool**：纯内容审查编辑工具
- **ReviewWithFeedbackTool**：带反馈的审查工具

**HITL工作流**：
```
内容生成 → 用户预览 → 编辑确认 → 反馈收集 → 内容更新
```

### 2.5 工件管理模块 (`artifact_tools.rs`, `idea_tools.rs`)
**功能职责**：开发工件的保存和加载管理

**核心工具**：
- **SaveIdeaTool**：项目构思保存工具
- **SaveDeliveryReportTool**：交付报告工具
- **SavePrdDocTool**：需求文档工具
- **SaveChangeRequestTool**：变更请求管理

**工件存储结构**：
```
.cowork/sessions/{session_id}/artifacts/
├── idea.md
├── prd.md
├── design.md
└── delivery_report.md
```

### 2.6 修改管理模块 (`modify_tools.rs` - 7KB)
**功能职责**：增量修改和变更管理支持

**核心工具**：
- **SaveChangeRequestTool**：变更请求保存
- **SavePatchMetadataTool**：补丁元数据管理
- 变更影响分析工具

### 2.7 验证工具模块 (`validation_tools.rs`)
**功能职责**：数据格式和质量验证

**核心工具**：
- **CheckDataFormatTool**：JSON Schema验证
- **CheckCoverageTool**：覆盖度检查
- **CheckDependenciesTool**：依赖关系验证

## 3. 技术实现特点

### 3.1 标准化接口设计
所有工具实现统一的Tool trait接口：
```rust
[async_trait]
pub trait Tool: Send + Sync {
    fn name(&self) -> &str;
    fn description(&self) -> &str;
    fn parameters_schema(&self) -> Option<Value>;
    async fn execute(&self, ctx: Arc<dyn ToolContext>, args: Value) -> Result<Value, AdkError>;
}
```

### 3.2 会话隔离架构
每个工具实例绑定特定session_id，确保多项目数据隔离：
```rust
pub struct CreateRequirementTool {
    session_id: String,  // 会话标识
}
```

### 3.3 安全防护机制
- **路径安全验证**：防止目录遍历和绝对路径访问
- **命令执行限制**：参数验证和权限控制
- **数据完整性检查**：JSON Schema验证和格式检查

### 3.4 错误处理策略
统一的错误处理模式：
```rust
.map_err(|e| AdkError::Tool(e.to_string()))?;
```

## 4. 模块间协作关系

### 4.1 与智能体工作流域的协作
工具功能域为智能体提供具体操作能力：
- **构思阶段**：使用idea_tools保存项目构思
- **设计阶段**：使用data_tools创建架构设计
- **编码阶段**：使用file_tools进行代码文件操作
- **交付阶段**：使用artifact_tools生成报告

### 4.2 与数据存储域的协作
- 通过storage模块进行数据持久化
- 使用data模块的数据模型定义
- 支持JSON序列化/反序列化

### 4.3 与LLM集成域的协作
- 依赖配置管理进行参数设置
- 支持AI生成内容的处理和验证

## 5. 性能与扩展性

### 5.1 性能优化
- **异步执行**：所有工具支持async/await
- **内存管理**：使用Arc共享上下文，减少拷贝
- **批处理支持**：数据工具支持批量操作

### 5.2 扩展性设计
- **模块化架构**：新工具可独立开发和集成
- **标准化接口**：统一工具注册和管理机制
- **配置驱动**：工具行为可通过配置调整

## 6. 使用场景示例

### 6.1 完整项目创建流程
```rust
// 1. 构思阶段 - 保存项目构思
SaveIdeaTool::new(session_id).execute(ctx, idea_content).await?;

// 2. 需求阶段 - 创建需求文档
CreateRequirementTool::new(session_id).execute(ctx, req_data).await?;

// 3. 设计阶段 - 保存架构设计
SaveDesignDocTool::new(session_id).execute(ctx, design_content).await?;
```

### 6.2 HITL交互场景
```rust
// 用户审查和编辑PRD文档
let result = ReviewAndEditContentTool.execute(ctx, json!({
    "title": "PRD文档审查",
    "content": prd_content
})).await?;
```

## 7. 总结

工具功能域作为Cowork Forge系统的操作执行层，提供了完整、安全、高效的软件开发工具集。通过模块化设计和标准化接口，既保证了系统的可维护性，又支持了功能的灵活扩展。该域的11个子模块协同工作，为AI驱动的软件开发生命周期提供了坚实的技术基础。