# 验证安全域技术文档

## 1. 模块概述

验证安全域是Cowork AI Agent System中的质量保证核心模块，负责在代码生成和验证过程中提供多层安全保障。该域包含验证执行器、安全检查器、项目检测器和错误提取器四个核心子模块，确保系统在执行外部命令时的安全性和可靠性。

## 2. 模块架构设计

### 2.1 总体架构

```
验证安全域架构图：
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   项目检测器     │    │   安全检查器     │    │   验证执行器     │
│  (detector.rs)   │───▶│   (safety.rs)   │───▶│   (runner.rs)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ 错误提取器      │    │  安全策略库     │    │ 命令执行引擎    │
│ (error_extract.rs) │ │   (多层防护)    │    │  (/bin/sh -lc)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 核心数据模型

```rust
// 验证命令结构
pub struct VerificationCommand {
    pub phase: Phase,      // 执行阶段(Check/Test/Build等)
    pub cmd: String,       // 具体命令
    pub expect: String,    // 预期结果
    pub optional: bool,    // 是否为可选验证
}

// 命令执行结果
pub struct CommandOutput {
    pub status_code: i32,  // 退出状态码
    pub stdout: String,    // 标准输出
    pub stderr: String,    // 标准错误
}

// 验证结果
pub struct VerificationResult {
    pub cmd: VerificationCommand,
    pub output: CommandOutput,
    pub passed: bool,      // 验证是否通过
}

// 项目类型枚举
pub enum ProjectKind {
    Rust,    // Rust项目
    Node,    // Node.js项目  
    Python,  // Python项目
    Html,    // HTML项目
    Unknown, // 未知类型
}
```

## 3. 核心子模块详解

### 3.1 项目检测器 (detector.rs)

**功能职责：**
- 自动识别项目类型和技术栈
- 基于文件指纹的确定性检测
- 支持Rust、Node.js、Python、HTML等常见项目类型

**核心实现：**
```rust
// 使用ignore库进行高效目录遍历
let walker = ignore::WalkBuilder::new(root)
    .hidden(false)
    .git_ignore(true)
    .git_global(true)
    .git_exclude(true)
    .follow_links(false)
    .build();
```

**检测逻辑：**
- Rust项目：存在`Cargo.toml`文件
- Node.js项目：存在`package.json`文件  
- Python项目：包含`.py`文件
- HTML项目：包含`.html`文件

### 3.2 安全检查器 (safety.rs)

**三层安全防护机制：**

#### 3.2.1 危险模式检测（立即阻断）
- 文件系统破坏命令：`rm -rf /`、`dd`写入块设备等
- 权限提升操作：`sudo`结合危险命令
- 系统修改：`systemctl stop`、`chmod 777 /`等
- 网络/安全风险：管道到shell的执行、Netcat监听等

#### 3.2.2 关键路径保护
- 系统关键路径：`/`, `/bin`, `/etc`, `/usr`等
- Windows系统路径：`C:\`, `C:\Windows`等
- 只读命令白名单：`cat`, `ls`, `grep`, `find`等

#### 3.2.3 可疑模式警告
- 递归删除通配符：`rm -rf *`、`rm -rf ..`等
- 查找删除操作：`find -delete`
- 管道到删除：`xargs rm`
- 系统设备操作：写入`/dev/null`等

### 3.3 验证执行器 (runner.rs)

**命令执行策略：**
- 使用`/bin/sh -lc`确保跨语言兼容性
- 支持复杂命令链：`cd subdir && npm run build`
- 完整的结果捕获：状态码、标准输出、标准错误

**安全执行流程：**
```rust
pub fn run_commands(working_dir: &str, commands: &[VerificationCommand]) -> Vec<VerificationResult> {
    commands.iter().map(|cmd| {
        match check_command_safety(&cmd.cmd, working_dir) {
            SafetyCheckResult::Safe => execute_and_return(cmd, working_dir),
            SafetyCheckResult::Blocked(reason) => create_safety_error(cmd, reason),
            SafetyCheckResult::Suspicious(reason) => log_warn_and_execute(cmd, working_dir, reason),
        }
    }).collect()
}
```

### 3.4 错误提取器 (error_extract.rs)

**功能特点：**
- 结构化错误信息提取
- 跨语言错误模式识别
- 为反馈循环提供可操作的错误信息

## 4. 验证命令配置

### 4.1 默认验证命令集

**Rust项目：**
```rust
VerificationCommand {
    phase: Phase::Check,
    cmd: "cargo check".to_string(),
    expect: "compiles".to_string(),
    optional: false,
}
```

**Node.js项目：**
```rust
VerificationCommand {
    phase: Phase::Build,
    cmd: "npm run build".to_string(),
    expect: "build succeeds".to_string(),
    optional: true,
}
```

**Python项目：**
```rust
VerificationCommand {
    phase: Phase::Check,
    cmd: "python3 -m py_compile $(find . -name '*.py' -maxdepth 6 | head -n 200)".to_string(),
    expect: "python syntax ok".to_string(),
    optional: false,
}
```

## 5. 安全策略设计

### 5.1 正则表达式模式库

**危险模式示例：**
```rust
// 文件系统破坏
Regex::new(r"\brm\s+(-[rf]+\s+)?/").unwrap(),

// 权限提升
Regex::new(r"\bsudo\s+rm\s+-rf").unwrap(),

// 管道到shell的风险
Regex::new(r"\bcurl\s+.*\|\s*(sh|bash|zsh)").unwrap(),
```

### 5.2 构建/测试命令白名单

**有效前缀列表：**
- `cargo `, `npm `, `yarn `, `python `
- `pytest`, `pip `, `mvn `, `gradle `
- `make `, `go `, `rustc `, `tsc `

## 6. 系统集成与交互

### 6.1 与智能体协作域的集成

验证安全域主要服务于检查智能体（CheckAgent），在代码生成后执行质量验证：

```
编码阶段智能体 → 生成代码 → 检查智能体 → 验证安全域 → 验证结果反馈
```

### 6.2 与工具支持域的协作

验证执行器依赖工具支持域的命令执行能力，但增加了额外的安全检查层：

```
工具支持域(命令执行) ← 验证安全域(安全检查) ← 业务智能体
```

## 7. 技术特点与优势

### 7.1 安全性设计
- **纵深防御**：多层安全检查机制
- **最小权限**：限制对系统关键路径的访问
- **安全默认值**：默认阻断危险操作

### 7.2 兼容性设计  
- **跨语言支持**：统一的命令执行接口
- **跨平台兼容**：支持Linux/macOS/Windows路径
- **灵活配置**：可选的验证命令和期望结果

### 7.3 可观测性
- **详细日志**：危险操作记录和警告
- **结构化输出**：标准化的验证结果格式
- **错误追踪**：完整的错误信息捕获

## 8. 最佳实践

### 8.1 安全配置建议
- 在生产环境中启用所有安全检查
- 定期审查安全模式库的更新
- 根据项目需求调整可选验证命令

### 8.2 性能优化
- 使用ignore库进行高效文件遍历
- 限制递归目录深度（maxdepth参数）
- 批量处理验证命令避免重复安全检查

验证安全域通过精心设计的多层防护机制，为Cowork AI Agent System提供了可靠的安全保障，确保在自动化代码生成和验证过程中不会对系统造成损害，同时保持了对多种编程语言和技术栈的良好支持。