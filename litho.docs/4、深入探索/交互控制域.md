# 交互控制域技术文档

## 1. 模块概述

### 1.1 模块定位
交互控制域（HitlController）是Cowork Forge AI Agent System中负责管理人机交互的核心模块。该模块基于Human-in-the-Loop（HITL）理念设计，在AI驱动的自动化开发流程中引入人工验证环节，确保系统输出的准确性和可控性。

### 1.2 核心价值
- **质量保证**：通过人工审查确保AI生成内容的质量和准确性
- **风险控制**：在关键决策点引入人工干预，避免AI决策偏差
- **用户体验**：提供直观的终端交互界面，支持内容审查和修改
- **流程可控**：保持自动化流程的高效性，同时在关键节点保持人工控制权

## 2. 架构设计

### 2.1 模块结构
```rust
pub struct HitlController;

impl HitlController {
    pub fn new() -> Self
    pub fn input(&self, prompt: &str) -> Result<String>
    pub fn confirm(&self, prompt: &str) -> Result<bool>
    pub fn review_and_edit_json<T>(&self, title: &str, data: &T) -> Result<Option<String>>
    pub fn review<T>(&self, title: &str, data: &T) -> Result<bool>
    pub fn collect_feedback(&self, prompt: &str) -> Result<String>
    pub fn collect_feedback_with_default(&self, prompt: &str, default: &str) -> Result<String>
    pub fn select(&self, prompt: &str, options: &[&str]) -> Result<usize>
}
```

### 2.2 技术栈依赖
- **dialoguer**: 终端交互库，提供丰富的命令行交互组件
- **serde**: JSON序列化/反序列化库，支持结构化数据编辑
- **anyhow**: 错误处理库，提供统一的错误处理机制

## 3. 核心功能实现

### 3.1 文本输入功能（input方法）
```rust
pub fn input(&self, prompt: &str) -> Result<String>
```
**功能特点**：
- 支持空值输入（`allow_empty(true)`）
- 提供清晰的提示信息
- 直接返回用户输入的字符串

**使用场景**：
- 获取用户需求描述
- 收集配置信息
- 输入补充说明

### 3.2 确认操作功能（confirm方法）
```rust
pub fn confirm(&self, prompt: &str) -> Result<bool>
```
**功能特点**：
- 默认值为`true`，优化用户体验
- 清晰的提示信息显示
- 返回布尔类型确认结果

**使用场景**：
- 确认AI生成内容
- 确认操作执行
- 决策点确认

### 3.3 JSON内容审查编辑（review_and_edit_json方法）
```rust
pub fn review_and_edit_json<T>(&self, title: &str, data: &T) -> Result<Option<String>>
```
**核心流程**：
1. **内容预览**：格式化显示JSON内容，限制显示前10行
2. **编辑决策**：询问用户是否需要编辑
3. **外部编辑**：调用系统默认编辑器进行内容修改
4. **格式验证**：验证修改后的JSON格式正确性
5. **重试机制**：格式错误时提供重试选项

**错误处理机制**：
- JSON格式验证失败时提供重试选项
- 支持放弃修改，使用原始内容
- 完善的错误信息提示

### 3.4 简化版内容审查（review方法）
```rust
pub fn review<T>(&self, title: &str, data: &T) -> Result<bool>
```
**设计理念**：
- 适用于不需要深度编辑的场景
- 提供格式化的显示界面
- 简化交互流程，提高效率

### 3.5 反馈收集功能
```rust
pub fn collect_feedback(&self, prompt: &str) -> Result<String>
pub fn collect_feedback_with_default(&self, prompt: &str, default: &str) -> Result<String>
```
**功能特点**：
- 支持空反馈和预填充反馈
- 使用外部编辑器提供丰富的编辑能力
- 自动去除前后空白字符

### 3.6 菜单选择功能（select方法）
```rust
pub fn select(&self, prompt: &str, options: &[&str]) -> Result<usize>
```
**功能特点**：
- 默认选择第一个选项
- 支持任意数量的选项
- 返回选择项的索引值

## 4. 交互流程设计

### 4.1 交互触发机制
交互控制域在软件开发生命周期的关键节点被触发：
- **PRD生成后**：产品需求文档确认
- **技术设计后**：架构设计方案审查
- **实施计划后**：开发计划确认
- **代码计划后**：代码变更计划审查

### 4.2 错误恢复机制
```rust
// JSON格式验证失败时的重试逻辑
let retry = Confirm::new()
    .with_prompt("是否重新编辑？")
    .default(true)
    .interact()?;

if retry {
    self.review_and_edit_json(title, data)  // 递归重试
} else {
    println!("⚠️  放弃修改，使用原始内容");
    Ok(None)
}
```

### 4.3 用户体验优化
- **渐进式显示**：大量内容时仅显示前10行预览
- **默认值优化**：确认操作默认接受，减少用户操作
- **格式美化**：使用分隔线和格式化显示提升可读性
- **状态反馈**：清晰的成功/失败状态提示

## 5. 集成架构

### 5.1 与工作流编排域的集成
交互控制域通过StageExecutor与工作流编排域紧密集成：
```rust
// 在阶段执行过程中调用HITL交互
let hitl_controller = HitlController::new();
let approved = hitl_controller.review("PRD文档", &prd_content)?;

if !approved {
    // 触发重新执行或调整流程
    return self.handle_rejection(stage);
}
```

### 5.2 与智能体协作域的协作
各业务智能体在生成关键产出物后，通过交互控制域获取用户确认：
- **PRD智能体**：产品需求文档确认
- **设计智能体**：技术设计方案审查  
- **计划智能体**：实施计划确认
- **编码智能体**：代码变更计划审查

### 5.3 数据流设计
```
智能体生成内容 → HITL控制器展示 → 用户审查/编辑 → 结果返回智能体
        ↓
    内容持久化存储 ← 确认后的最终内容
```

## 6. 技术实现细节

### 6.1 泛型设计
```rust
pub fn review_and_edit_json<T>(&self, title: &str, data: &T) -> Result<Option<String>>
where
    T: Serialize,  // 要求类型支持序列化
```
支持任意可序列化类型，提高模块的通用性。

### 6.2 错误处理策略
使用`anyhow::Result`统一错误处理，支持错误传播和上下文信息。

### 6.3 资源管理
- 编辑器资源自动释放
- 内存使用优化（大文件分块处理）
- 临时文件清理机制

## 7. 性能与安全考虑

### 7.1 性能优化
- **懒加载**：仅在需要时初始化交互组件
- **内容分块**：大文件内容分块显示和编辑
- **异步支持**：为未来异步交互预留接口

### 7.2 安全机制
- **输入验证**：JSON格式严格验证
- **命令安全**：防止命令注入攻击
- **权限控制**：文件操作权限检查

## 8. 扩展性设计

### 8.1 插件化架构
模块设计支持未来扩展：
- 支持不同的交互前端（GUI、Web界面）
- 可配置的交互策略
- 自定义验证规则

### 8.2 配置驱动
预留配置接口，支持：
- 交互超时设置
- 最大重试次数配置
- 默认编辑器选择

交互控制域作为Cowork Forge AI Agent System中人机协同的关键桥梁，通过精心设计的交互流程和稳健的技术实现，在保持自动化效率的同时确保了系统的可靠性和用户体验。该模块的设计体现了现代AI系统中Human-in-the-Loop理念的最佳实践。