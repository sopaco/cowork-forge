# Cowork Forge å·¥å…·åŠŸèƒ½åŸŸæŠ€æœ¯æ–‡æ¡£

## 1. æ¦‚è¿°

å·¥å…·åŠŸèƒ½åŸŸæ˜¯Cowork Forgeç³»ç»Ÿçš„æ ¸å¿ƒåŸºç¡€è®¾æ–½å±‚ï¼Œä¸ºæ•´ä¸ªAIé©±åŠ¨çš„è½¯ä»¶å¼€å‘ç¼–æ’ç³»ç»Ÿæä¾›åŸºç¡€å·¥å…·å’ŒæœåŠ¡æ”¯æŒã€‚è¯¥åŸŸé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼ŒåŒ…å«æ–‡ä»¶æ“ä½œã€æ•°æ®ç®¡ç†ã€éªŒè¯å·¥å…·ã€LLMé›†æˆå’Œäº¤äº’æ§åˆ¶äº”å¤§æ ¸å¿ƒæ¨¡å—ï¼Œä¸ºä¸Šå±‚æ™ºèƒ½ä½“æŒ‡ä»¤åŸŸå’Œå·¥ä½œæµç¼–æ’åŸŸæä¾›ç»Ÿä¸€çš„å·¥å…·æ¥å£ã€‚

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

å·¥å…·åŠŸèƒ½åŸŸä½äºç³»ç»Ÿæ¶æ„çš„åŸºç¡€è®¾æ–½å±‚ï¼Œé‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼š

```
æ™ºèƒ½ä½“æŒ‡ä»¤åŸŸ (ä¸šåŠ¡é€»è¾‘å±‚)
    â†“
å·¥å…·åŠŸèƒ½åŸŸ (åŸºç¡€è®¾æ–½å±‚)
    â†“
æ•°æ®å­˜å‚¨åŸŸ (æ•°æ®æŒä¹…å±‚)
```

### 2.2 æ¨¡å—ç»„æˆ

#### 2.2.1 æ ¸å¿ƒæ¨¡å—ç»“æ„

```
å·¥å…·åŠŸèƒ½åŸŸ
â”œâ”€â”€ æ–‡ä»¶æ“ä½œæ¨¡å— (file_tools.rs)
â”œâ”€â”€ æ•°æ®ç®¡ç†æ¨¡å— (data_tools.rs) 
â”œâ”€â”€ éªŒè¯å·¥å…·æ¨¡å— (validation_tools.rs)
â”œâ”€â”€ LLMé›†æˆæ¨¡å— (llm/config.rs, llm/rate_limiter.rs)
â””â”€â”€ äº¤äº’æ§åˆ¶æ¨¡å— (control_tools.rs, hitl_tools.rs)
```

## 3. æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 3.1 æ–‡ä»¶æ“ä½œæ¨¡å— (`file_tools.rs`)

#### 3.1.1 å®‰å…¨æœºåˆ¶è®¾è®¡
è¯¥æ¨¡å—å®ç°äº†ä¸¥æ ¼çš„å®‰å…¨è·¯å¾„éªŒè¯æœºåˆ¶ï¼š
- **è·¯å¾„ç›¸å¯¹æ€§éªŒè¯**ï¼šç¦æ­¢ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œé˜²æ­¢ç³»ç»Ÿæ–‡ä»¶è®¿é—®
- **ç›®å½•éå†é˜²æŠ¤**ï¼šæ£€æµ‹å¹¶é˜»æ­¢`..`æ“ä½œç¬¦çš„ä½¿ç”¨
- **è¾¹ç•Œæ£€æŸ¥**ï¼šç¡®ä¿æ‰€æœ‰æ–‡ä»¶æ“ä½œé™åˆ¶åœ¨å½“å‰å·¥ä½œç›®å½•å†…

```rust
fn validate_path_security(path: &str) -> Result<PathBuf, String> {
    // 1. æ‹’ç»ç»å¯¹è·¯å¾„
    if path_obj.is_absolute() {
        return Err("Security: Absolute paths are not allowed".to_string());
    }
    
    // 2. æ‹’ç»çˆ¶ç›®å½•è®¿é—®
    if path.contains("..") {
        return Err("Security: Parent directory access is not allowed".to_string());
    }
    
    // 3. è§„èŒƒåŒ–è·¯å¾„å¹¶éªŒè¯è¾¹ç•Œ
    let canonical_path = full_path.canonicalize()?;
    if !canonical_path.starts_with(&current_dir) {
        return Err("Security: Path escapes current directory".to_string());
    }
}
```

#### 3.1.2 æ ¸å¿ƒå·¥å…·å®ç°
- **ListFilesTool**ï¼šç›®å½•æ–‡ä»¶åˆ—è¡¨å·¥å…·ï¼Œæ”¯æŒé€’å½’å’Œéé€’å½’æ¨¡å¼
- **ReadFileTool**ï¼šå®‰å…¨æ–‡ä»¶è¯»å–å·¥å…·ï¼Œæ”¯æŒè¡ŒèŒƒå›´é™åˆ¶
- **WriteFileTool**ï¼šæ–‡ä»¶å†™å…¥å·¥å…·ï¼ŒåŒ…å«å¤‡ä»½å’ŒåŸå­å†™å…¥æœºåˆ¶
- **RunCommandTool**ï¼šå‘½ä»¤æ‰§è¡Œå·¥å…·ï¼Œå…·å¤‡è¶…æ—¶æ§åˆ¶å’Œè¾“å‡ºæ•è·

### 3.2 æ•°æ®ç®¡ç†æ¨¡å— (`data_tools.rs`)

#### 3.2.1 ç»“æ„åŒ–æ•°æ®ç®¡ç†
è¯¥æ¨¡å—æä¾›å®Œæ•´çš„CRUDæ“ä½œå·¥å…·é›†ï¼Œæ”¯æŒä¼šè¯çº§åˆ«çš„æ•°æ®ç®¡ç†ï¼š

```rust
pub struct CreateRequirementTool {
    session_id: String,  // ä¼šè¯éš”ç¦»æ ‡è¯†
}

impl Tool for CreateRequirementTool {
    fn name(&self) -> &str { "create_requirement" }
    
    fn parameters_schema(&self) -> Option<Value> {
        Some(json!({
            "type": "object",
            "properties": {
                "title": {"type": "string"},
                "description": {"type": "string"},
                "priority": {"enum["high", "medium", "low"]},
                "category": {"enum": ["functional", "non_functional"]},
                "acceptance_criteria": {"type": "array"}
            }
        }))
    }
}
```

#### 3.2.2 æ•°æ®æ¨¡å‹æ”¯æŒ
- **éœ€æ±‚ç®¡ç†**ï¼šæ”¯æŒSMARTåŸåˆ™çš„éœ€æ±‚åˆ›å»ºå’ŒéªŒè¯
- **åŠŸèƒ½ç‰¹æ€§**ï¼šåŠŸèƒ½ç»„ä»¶å®šä¹‰å’Œä¾èµ–å…³ç³»ç®¡ç†
- **è®¾è®¡ç»„ä»¶**ï¼šæ¶æ„è®¾è®¡å…ƒç´ ç®¡ç†
- **ä»»åŠ¡è§„åˆ’**ï¼šå¼€å‘ä»»åŠ¡åˆ†è§£å’ŒçŠ¶æ€è·Ÿè¸ª

### 3.3 éªŒè¯å·¥å…·æ¨¡å— (`validation_tools.rs`)

#### 3.3.1 æ•°æ®è´¨é‡éªŒè¯
æä¾›å¤šå±‚æ¬¡çš„æ•°æ®éªŒè¯æœºåˆ¶ï¼š

```rust
pub struct CheckDataFormatTool {
    session_id: String,
}

impl CheckDataFormatTool {
    fn validate_requirements_schema(&self) -> Vec<String> {
        let mut errors = vec![];
        let requirements = load_requirements(&self.session_id)?;
        
        for req in &requirements.requirements {
            if req.title.is_empty() {
                errors.push(format!("{}: title is empty", req.id));
            }
            // æ›´å¤šéªŒè¯è§„åˆ™...
        }
        errors
    }
}
```

#### 3.3.2 éªŒè¯ç±»å‹
- **æ ¼å¼éªŒè¯**ï¼šJSON Schemaä¸€è‡´æ€§æ£€æŸ¥
- **è¦†ç›–æ€§æ£€æŸ¥**ï¼šåŠŸèƒ½éœ€æ±‚è¦†ç›–åº¦åˆ†æ
- **ä¾èµ–åˆ†æ**ï¼šä»»åŠ¡ä¾èµ–å…³ç³»éªŒè¯
- **å®Œæ•´æ€§æ£€æŸ¥**ï¼šé¡¹ç›®äº¤ä»˜å®Œæ•´æ€§éªŒè¯

### 3.4 LLMé›†æˆæ¨¡å—

#### 3.4.1 é…ç½®ç®¡ç† (`llm/config.rs`)
æ”¯æŒå¤šç¯å¢ƒé…ç½®åŠ è½½ï¼š

```rust
pub struct ModelConfig {
    pub llm: LlmConfig,
}

impl ModelConfig {
    // ä»é…ç½®æ–‡ä»¶åŠ è½½
    pub fn from_file(path: &str) -> Result<Self> {
        let content = std::fs::read_to_string(path)?;
        toml::from_str(&content)
    }
    
    // ä»ç¯å¢ƒå˜é‡åŠ è½½ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
    pub fn from_env() -> Result<Self> {
        Ok(Self {
            llm: LlmConfig {
                api_base_url: std::env::var("LLM_API_BASE_URL")?,
                api_key: std::env::var("LLM_API_KEY")?,
                model_name: std::env::var("LLM_MODEL_NAME")?,
            },
        })
    }
}
```

#### 3.4.2 é€Ÿç‡é™åˆ¶ (`llm/rate_limiter.rs`)
å®ç°æ™ºèƒ½é€Ÿç‡æ§åˆ¶æœºåˆ¶ï¼š

```rust
pub struct RateLimitedLlm {
    inner: Arc<dyn Llm>,
    delay_ms: u64,  // é»˜è®¤2000ms (<30 calls/min)
}

#[async_trait]
impl Llm for RateLimitedLlm {
    async fn generate_content(&self, req: LlmRequest, stream: bool) -> Result<LlmResponseStream> {
        // è°ƒç”¨å‰ç­‰å¾…
        sleep(Duration::from_millis(self.delay_ms)).await;
        self.inner.generate_content(req, stream).await
    }
}
```

### 3.5 äº¤äº’æ§åˆ¶æ¨¡å—

#### 3.5.1 HITLå·¥å…· (`hitl_tools.rs`)
å®ç°äººå·¥ä»‹å…¥å¾ªç¯æœºåˆ¶ï¼š

```rust
pub struct ReviewAndEditFileTool;

impl Tool for ReviewAndEditFileTool {
    async fn execute(&self, _ctx: Arc<dyn ToolContext>, args: Value) -> Result<Value> {
        let file_path = args["file_path"].as_str().unwrap();
        let title = args["title"].as_str().unwrap();
        
        // æ–‡ä»¶é¢„è§ˆ
        println!("ğŸ“ {} - {}", title, file_path);
        // æ˜¾ç¤ºæ–‡ä»¶å†…å®¹...
        
        // ç”¨æˆ·äº¤äº’
        let should_edit = Confirm::new()
            .with_prompt("Do you want to edit this file? (y/n)")
            .interact()?;
            
        if should_edit {
            // æ‰“å¼€ç¼–è¾‘å™¨...
        }
    }
}
```

#### 3.5.2 æµç¨‹æ§åˆ¶å·¥å…· (`control_tools.rs`)
- **RequestReplanningTool**ï¼šé‡å¤§æ¶æ„é—®é¢˜æ—¶çš„é‡æ–°è§„åˆ’è¯·æ±‚
- **ProvideFeedbackTool**ï¼šç”¨æˆ·åé¦ˆæ”¶é›†å’Œå¤„ç†
- **AskUserTool**ï¼šå…³é”®å†³ç­–ç‚¹çš„ç”¨æˆ·è¯¢é—®

## 4. æŠ€æœ¯å®ç°ç‰¹ç‚¹

### 4.1 å¼‚æ­¥æ¶æ„
æ‰€æœ‰å·¥å…·å‡åŸºäº`async_trait`å®ç°å¼‚æ­¥æ“ä½œï¼Œæ”¯æŒé«˜æ€§èƒ½å¹¶å‘å¤„ç†ï¼š

```rust
#[async_trait]
impl Tool for ListFilesTool {
    async fn execute(&self, _ctx: Arc<dyn ToolContext>, args: Value) -> Result<Value> {
        // å¼‚æ­¥æ–‡ä»¶æ“ä½œ...
    }
}
```

### 4.2 ç±»å‹å®‰å…¨
ä½¿ç”¨Rustå¼ºç±»å‹ç³»ç»Ÿå’Œserde_jsonå®ç°å‚æ•°éªŒè¯ï¼š

```rust
fn parameters_schema(&self) -> Option<Value> {
    Some(json!({
        "type": "object",
        "properties": {
            "path": {"type": "string"},
            "recursive": {"type": "boolean"},
            "max_depth": {"type": "integer"}
        }
    }))
}
```

### 4.3 ä¼šè¯éš”ç¦»
é€šè¿‡session_idå®ç°å¤šä¼šè¯æ•°æ®éš”ç¦»ï¼Œæ”¯æŒå¹¶è¡Œé¡¹ç›®å¼€å‘ï¼š

```rust
pub struct CreateRequirementTool {
    session_id: String,  // ä¼šè¯æ ‡è¯†ç¬¦
}
```

## 5. å®‰å…¨è®¾è®¡

### 5.1 æ–‡ä»¶æ“ä½œå®‰å…¨
- **è·¯å¾„éªŒè¯**ï¼šé˜²æ­¢ç›®å½•éå†æ”»å‡»
- **æƒé™æ§åˆ¶**ï¼šé™åˆ¶æ–‡ä»¶æ“ä½œèŒƒå›´
- **å‘½ä»¤æ‰§è¡Œ**ï¼šè¶…æ—¶æ§åˆ¶å’Œè¾“å‡ºè¿‡æ»¤

### 5.2 æ•°æ®å®‰å…¨
- **è¾“å…¥éªŒè¯**ï¼šä¸¥æ ¼çš„å‚æ•°æ ¼å¼æ£€æŸ¥
- **ä¼šè¯éš”ç¦»**ï¼šé˜²æ­¢æ•°æ®äº¤å‰æ±¡æŸ“
- **é”™è¯¯å¤„ç†**ï¼šå®‰å…¨çš„é”™è¯¯ä¿¡æ¯æš´éœ²

### 5.3 APIå®‰å…¨
- **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢APIæ»¥ç”¨
- **é…ç½®åŠ å¯†**ï¼šæ•æ„Ÿä¿¡æ¯ä¿æŠ¤
- **è¯·æ±‚éªŒè¯**ï¼šLLMè°ƒç”¨å‚æ•°æ ¡éªŒ

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 å†…å­˜ç®¡ç†
- ä½¿ç”¨Arcå®ç°å·¥å…·å®ä¾‹çš„çº¿ç¨‹å®‰å…¨å…±äº«
- å¤§æ–‡ä»¶å¤„ç†çš„æµå¼è¯»å–å’Œå†™å…¥
- é¿å…ä¸å¿…è¦çš„æ•°æ®å¤åˆ¶

### 6.2 å¹¶å‘å¤„ç†
- å¼‚æ­¥å·¥å…·æ‰§è¡Œæ”¯æŒé«˜å¹¶å‘
- éé˜»å¡çš„LLM APIè°ƒç”¨
- å¹¶è¡Œæ–‡ä»¶æ“ä½œæ”¯æŒ

### 6.3 ç¼“å­˜ç­–ç•¥
- ä¼šè¯æ•°æ®çš„æœ¬åœ°ç¼“å­˜
- LLMå“åº”çš„æ™ºèƒ½ç¼“å­˜
- æ–‡ä»¶å…ƒæ•°æ®çš„ç¼“å­˜ä¼˜åŒ–

## 7. æ‰©å±•æ€§è®¾è®¡

### 7.1 æ¨¡å—åŒ–æ‰©å±•
æ–°çš„å·¥å…·å¯ä»¥é€šè¿‡å®ç°ç»Ÿä¸€çš„Tool traitè½»æ¾é›†æˆï¼š

```rust
#[async_trait]
pub trait Tool: Send + Sync {
    fn name(&self) -> &str;
    fn description(&self) -> &str;
    fn parameters_schema(&self) -> Option<Value>;
    async fn execute(&self, ctx: Arc<dyn ToolContext>, args: Value) -> Result<Value>;
}
```

### 7.2 é…ç½®é©±åŠ¨
æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€è°ƒæ•´å·¥å…·è¡Œä¸ºï¼š
- LLMç«¯ç‚¹å’Œæ¨¡å‹é…ç½®
- é€Ÿç‡é™åˆ¶å‚æ•°è°ƒæ•´
- å®‰å…¨ç­–ç•¥é…ç½®

## 8. æ€»ç»“

å·¥å…·åŠŸèƒ½åŸŸä½œä¸ºCowork Forgeç³»ç»Ÿçš„åŸºç¡€è®¾æ–½å±‚ï¼Œé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æ¨¡å—åŒ–æ¶æ„å’Œå®‰å…¨æœºåˆ¶ï¼Œä¸ºä¸Šå±‚AIæ™ºèƒ½ä½“æä¾›äº†å¯é çš„å·¥å…·æ”¯æŒã€‚è¯¥åŸŸçš„è®¾è®¡å……åˆ†è€ƒè™‘äº†å®‰å…¨æ€§ã€æ€§èƒ½å’Œæ‰©å±•æ€§è¦æ±‚ï¼Œæ˜¯ç³»ç»Ÿç¨³å®šè¿è¡Œçš„é‡è¦ä¿éšœã€‚

æ¨¡å—é—´çš„æ¸…æ™°èŒè´£åˆ’åˆ†å’Œç»Ÿä¸€çš„æ¥å£è®¾è®¡ï¼Œä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿçµæ´»åº”å¯¹ä¸åŒçš„å¼€å‘åœºæ™¯éœ€æ±‚ï¼ŒåŒæ—¶ä¿æŒäº†è‰¯å¥½çš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚éšç€ç³»ç»ŸåŠŸèƒ½çš„ä¸æ–­æ‰©å±•ï¼Œå·¥å…·åŠŸèƒ½åŸŸå°†ç»§ç»­ä½œä¸ºæ ¸å¿ƒåŸºç¡€è®¾æ–½æ”¯æ’‘æ•´ä¸ªAIé©±åŠ¨å¼€å‘å¹³å°çš„å‘å±•ã€‚